CREATE SCHEMA suivi_abonnement_omnis_db;

CREATE VIEW suivi_abonnement_omnis_db.v_abonnements_par_client AS select `u`.`id` AS `idclient`,`u`.`username` AS `nomclient`,`u`.`email` AS `emailclient`,`u`.`role` AS `roleclient`,`a`.`abonnement_id` AS `abonnement_id`,`a`.`type` AS `type`,`a`.`prix` AS `prix`,`a`.`date_debut` AS `date_debut`,`a`.`expiration_date` AS `expiration_date`,`a`.`description` AS `description`,`a`.`nom` AS `nomabonnement`,`d`.`nom` AS `nomdepartement`,`f`.`nom` AS `nomfournisseur` from ((((`suivi_abonnement_omnis_db`.`users` `u` join `suivi_abonnement_omnis_db`.`departement_user` `du` on(`u`.`id` = `du`.`user_id`)) join `suivi_abonnement_omnis_db`.`departements` `d` on(`du`.`iddepartement` = `d`.`departement_id`)) join `suivi_abonnement_omnis_db`.`abonnements` `a` on(`a`.`departement_id` = `du`.`iddepartement`)) join `suivi_abonnement_omnis_db`.`fournisseurs` `f` on(`a`.`idfournisseur` = `f`.`fournisseur_id`)) order by `u`.`id`,`a`.`abonnement_id`;

CREATE VIEW suivi_abonnement_omnis_db.v_abonnements_user AS select `u`.`id` AS `user_id`,`u`.`username` AS `username`,`u`.`email` AS `email`,`dep`.`nom` AS `departement`,`a`.`abonnement_id` AS `abonnement_id`,`a`.`nom` AS `abonnement_nom`,`a`.`type` AS `abonnement_type`,`a`.`prix` AS `prix`,`a`.`date_debut` AS `date_debut`,`a`.`expiration_date` AS `expiration_date`,`a`.`description` AS `abonnement_description`,`f`.`nom` AS `fournisseur_nom`,`c`.`nom` AS `categorie_nom` from (((((`suivi_abonnement_omnis_db`.`users` `u` join `suivi_abonnement_omnis_db`.`departement_user` `du` on(`u`.`id` = `du`.`user_id`)) join `suivi_abonnement_omnis_db`.`abonnements` `a` on(`du`.`iddepartement` = `a`.`departement_id`)) join `suivi_abonnement_omnis_db`.`fournisseurs` `f` on(`a`.`idfournisseur` = `f`.`fournisseur_id`)) join `suivi_abonnement_omnis_db`.`categories` `c` on(`a`.`idcategorie` = `c`.`categorie_id`)) join `suivi_abonnement_omnis_db`.`departements` `dep` on(`du`.`iddepartement` = `dep`.`departement_id`)) group by `u`.`id`,`a`.`abonnement_id` order by `u`.`id`,`a`.`abonnement_id`;

CREATE VIEW suivi_abonnement_omnis_db.v_status_abonnements AS select `a`.`abonnement_id` AS `abonnement_id`,`a`.`type` AS `type`,`a`.`prix` AS `prix`,`a`.`date_debut` AS `date_debut`,`a`.`idfournisseur` AS `idfournisseur`,`a`.`idcategorie` AS `idcategorie`,`a`.`expiration_date` AS `expiration_date`,`a`.`description` AS `description`,`a`.`nom` AS `nom`,`a`.`departement_id` AS `departement_id`,`c`.`nom` AS `nom_categorie`,`f`.`nom` AS `nom_fournisseur`,`d`.`nom` AS `nom_departement`,case when `a`.`expiration_date` > current_timestamp() and `a`.`date_debut` < current_timestamp() then 'Actif' when `a`.`expiration_date` < current_timestamp() then 'Expire' else 'En attente' end AS `statut` from (((`suivi_abonnement_omnis_db`.`abonnements` `a` join `suivi_abonnement_omnis_db`.`departements` `d` on(`a`.`departement_id` = `d`.`departement_id`)) join `suivi_abonnement_omnis_db`.`categories` `c` on(`a`.`idcategorie` = `c`.`categorie_id`)) join `suivi_abonnement_omnis_db`.`fournisseurs` `f` on(`a`.`idfournisseur` = `f`.`fournisseur_id`));
